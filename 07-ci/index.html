<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<title>Continuous Integration</title>
<meta name="description" content="Make things work, keep them working, move fast">
<meta name="author" content="Danilo Pianini">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="/Course-Laboratory-of-Software-Systems/reveal-js/css/reset.css">
<link rel="stylesheet" href="/Course-Laboratory-of-Software-Systems/reveal-js/css/reveal.css">
  <link rel="stylesheet" href="/Course-Laboratory-of-Software-Systems/css/custom-theme.min.1e2604bf0c24e445faa3ae7d68b2f0146c34bc9e7b9bd6aee2b7187115560e96.css" id="theme"><link rel="stylesheet" href="/Course-Laboratory-of-Software-Systems/highlight-js/default.min.css">
    
<link rel="stylesheet" href="https://gitcdn.link/repo/DanySK/css-blur-animation/master/blur.css">
<link href='https://fonts.googleapis.com/css?family=Roboto Mono' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Oxygen Mono' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Ubuntu Mono' rel='stylesheet'>

  </head>
  <body>
    <div class="reveal">
      <div class="slides">
  

    <section><h1 id="hahahugoshortcode-s0-hbhb">Laboratory of Software Systems</h1>
<h2 id="continuous-integration">Continuous Integration</h2>
<h3 id="danilo-pianinimailtodanilopianiniuniboit"><a href="mailto:danilo.pianini@unibo.it">Danilo Pianini</a></h3>
2020-11-04

</section><section>
<h1 id="continuous-integration-1">Continuous Integration</h1>
<p>The practice of integrating code with a main development line <strong>continuously</strong>
<br>
<em>Verifying</em> that the build remains intact</p>
<ul>
<li>Requires <em>build automation</em> to be in place</li>
<li>Requires <em>testing</em> to be in place</li>
<li>Pivot point of the <em>DevOps</em> practices</li>
<li>Historically introduced by the extreme programming (XP) community</li>
<li>Now widespread in the larger DevOps community</li>
</ul>
</section><section>
<h1 id="the-integration-hell">The Integration Hell</h1>
<ul>
<li>Traditional software development takes several months for <em>“integrating”</em> a couple of years of development</li>
<li>The longer there is no integrated project, the higher the <strong>risk</strong></li>
</ul>
<p><img src="integration-traditional.png" style='
    
    
    max-width: 40vw;
    max-height: 50vh;
    object-fit: contain;
'>

<img src="integration-continuous.png" style='
    
    
    max-width: 40vw;
    max-height: 50vh;
    object-fit: contain;
'>
</p>
</section><section>
<h2 id="microreleases-and-protoduction">Microreleases and protoduction</h2>
<ul>
<li>High frequency integration may lead to high frequency releases
<ul>
<li>Possibly, <em>one per commit</em></li>
<li>Of course, <em>versioning</em> must be appropriate&hellip;</li>
</ul>
</li>
</ul>
<p>Traditionally, <strong>protoduction</strong> is jargon for a <em>prototype that ends up in production</em></p>
<img src="protoduction.jpg" style='
    
    
    max-width: 25vw;
    max-height: 40vh;
    object-fit: contain;
'>

<ul>
<li>Traditionally used with a <em>negative</em> meaning
<ul>
<li>It implied software
<ul>
<li><em>unfinished</em>,</li>
<li><em>unpolished</em>,</li>
<li><em>badly designed</em></li>
</ul>
</li>
<li>Very common, unfortunately</li>
</ul>
</li>
<li>This si different in a continuously integrated environment
<ul>
<li><em>Incrementality</em> is fostered</li>
<li>Partial features are <em>up to date</em> with the mainline</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="intensive-operations-should-be-elsewhere">Intensive operations should be elsewhere</h2>
<ul>
<li>The build process should be <em>rich</em> and <em>fast</em></li>
<li>Operations requiring a long time should be <em>automated</em>
<ul>
<li>And run somewhere else than devs&rsquo; PCs</li>
</ul>
</li>
</ul>
<p>
<img src="compiling.png" style='
    
    
    max-width: 95vw;
    max-height: 50vh;
    object-fit: contain;
'>

</p>
</section><section>
<h2 id="continuous-integration-software">Continuous integration software</h2>
<p>Software that promotes CI practices should:</p>
<ul>
<li>Provide <em>clean environments</em> for compilation/testing</li>
<li>Provide a <em>wide range</em> of environments
<ul>
<li>Matching the relevant specifications of the actual targets</li>
</ul>
</li>
<li>High degree of <em>configurability</em></li>
<li>Possibly, <em>declarative configuration</em></li>
<li>A <em>notification system</em> to alert about failures or issues</li>
<li>Support for <em>authentication</em> and deployment to external services</li>
</ul>
<p><strong>Plenty</strong> of integrators on the market</p>
<ul>
<li>Circle CI, Travis CI, Werker, done.io, Codefresh, Codeship, Bitbucket Pipelines&hellip;</li>
</ul>
<p>We will use Travis CI</p>
<ul>
<li>GitHub integration</li>
<li>Free for academy</li>
<li>Multiple OSs supported</li>
</ul>
</section><section>
<h1 id="core-concepts">Core concepts</h1>
<p><strong>phase</strong></p>
<ul>
<li>A <em>named sequence of commands</em></li>
<li>A phase succeeds if all the commands succeed</li>
<li>The next phase starts only if the previous was successful</li>
<li>The names and order of phases are <em>pre-determined</em></li>
</ul>
<p><strong>job</strong></p>
<ul>
<li>Operation consisting in:
<ul>
<li><em>spawning</em> of a fresh <em>virtual environment</em></li>
<li><em>configuration</em> of the virtual environment</li>
<li><em>cloning</em> of the repository</li>
<li><em>ordered execution of all phases</em></li>
</ul>
</li>
</ul>
</section><section>
<h1 id="core-concepts-1">Core concepts</h1>
<p><strong>stage</strong></p>
<ul>
<li>A <em>group of jobs</em> that run in parallel</li>
<li>A build finishes when all of its jobs are finished.</li>
<li>A stage is successful if all of its jobs are successful</li>
<li>The next stages starts only if the previous was successful</li>
</ul>
<p><strong>build</strong></p>
<ul>
<li>A <em>group of stages</em> that run in <em>sequence</em></li>
<li>A build finishes when all of its stages are finished.</li>
<li>A build is successful if all of its stages are successful</li>
</ul>
</section><section>
<h2 id="job-lifecycle">Job lifecycle</h2>


  
    
  


<figure>
  <img
    src='https://g.gravizo.com/svg?%0a%40startuml%0a%0a%28%2a%29%20-right-%3e%20%22before_install%22%0a%22before_install%22%20-right-%3e%20%22install%22%0a%22install%22%20-right-%3e%20%22before_script%22%0a%22before_script%22%20-right-%3e%20%22script%22%0a%22script%22%20-right-%3e%20%22before_cache%22%0aif%20%22TRAVIS_TEST_RESULT%22%20then%0a%20%20--%3e%20%5btrue%5d%20%22after_success%22%0a%20%20--%3e%20%22before_deploy%22%0aelse%0a%20%20--%3e%20%5bfalse%5d%20%22after_failure%22%0a%20%20--%3e%20%22before_deploy%22%0a%22before_deploy%22%20-left-%3e%20%22deploy%22%0a%22deploy%22%20-left-%3e%20%22after_deploy%22%0a%22after_deploy%22%20-left-%3e%20%22after_script%22%0a%22after_script%22%20-left-%3e%20%28%2a%29%0a%0a%40enduml%0a'
    alt='Travis CI Job lifecycle'
    />
    <figcaption>Travis CI Job lifecycle</figcaption>
</figure>

<ul>
<li>If <code>before_install</code>, <code>install</code> or <code>before_script</code> returns a non-zero exit code, the build is errored and stops immediately.</li>
<li>If <code>script</code> returns a non-zero exit code, the build is failed, but <em>continues to run</em> before being marked as failed.</li>
<li>The exit code of <code>after_success</code>, <code>after_failure</code>, <code>after_script</code>, <code>after_deploy</code> and subsequent stages <em>do not affect the build result</em>.
<ul>
<li>However, if one of these stages times out, the build is marked as failed.</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="travis-ci-configuration">Travis CI: Configuration</h2>
<p>Travis CI is configured in a single <code>travis.yml</code> file located in the repository root</p>
<p>At registration time, it integrates with GitHub</p>
<p>New pushes on repositories which contain <code>.travis.yml</code> get automatically built</p>
</section><section>
<h2 id="travis-ci-environment-selection">Travis CI: Environment selection</h2>
<p>By default, travis tries to build a <em>Ruby</em> project
<br>
Travis itself is written in Ruby</p>
<p>Selection of a different system configuration can be operated with the <code>language</code> keyword.
<br>
Over <a href="https://docs.travis-ci.com/user/language-specific/">30 languages</a> are natively supported.</p>
<p>Some of the most interesting for us are:</p>
<ul>
<li><code>java</code></li>
<li><code>scala</code></li>
<li><code>minimal</code> (bare environment with just bash and Ruby)</li>
</ul>
<p>Every environment has some <em>pre-defined behaviour</em>,
for instance the <code>language: java</code> environment automatically searches for a <code>pom.xml</code> and in case runs Maven,
if not found searches for a <code>gradlew</code> file and runs <code>./gradlew assemble</code> in the <code>install</code> phase and <code>./gradlew check</code> in the <code>script</code> phase.</p>
<ul>
<li>Default phase behavior can be disabled with <code>&lt;phase_name&gt;: true</code></li>
</ul>
</section><section>
<h2 id="travis-ci-clone-depth-control">Travis CI: clone depth control</h2>
<p>By default, Travis CI <em>does not clone the entire history</em> of a repository.
<br>
It performs instead a <em>shallow clone</em>, by running <code>git clone --depth 50 &lt;repo-url&gt;</code></p>
<p>This <em>interferes with DVCS-based versioning</em>, which may well need to look behind of many commits.</p>
<p>This behaviour can be controlled with the <code>git</code> key:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="nohighlight" data-noescape><span style="color:#080;font-weight:bold">git</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#080;font-weight:bold">depth</span>:<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">false</span><span style="color:#bbb"> </span><span style="color:#888"># Accepts false or any number representing the commit count, defaults to 50</span><span style="color:#bbb">
</span></code></pre></div><p>The same key allows for controlling further behaviour, such as disabling <code>autocrlf</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="nohighlight" data-noescape><span style="color:#080;font-weight:bold">git</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#080;font-weight:bold">depth</span>:<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">false</span><span style="color:#bbb"> </span><span style="color:#888"># Accepts false or any number representing the commit count, defaults to 50</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#080;font-weight:bold">autocrlf</span>:<span style="color:#bbb"> </span>input<span style="color:#bbb"> </span><span style="color:#888"># Prevents git from trying to be smart with line endings</span><span style="color:#bbb">
</span></code></pre></div></section><section>
<h2 id="travis-ci-testing-on-different-oss">Travis CI: Testing on different OSs</h2>
<p>If our software supports <em>multiple operating systems</em>, it is a good practice to verify that changes do not <em>break compatibility</em></p>
<p>A few integrators allow to perform a multi-os build. In Travis it is possible via the <code>os</code> key, supporting:</p>
<ul>
<li><code>linux</code> &ndash; A Ubuntu Linux installation</li>
<li><code>macos</code> &ndash; A MacOS X installation</li>
<li><code>windows</code> &ndash; A Windows Server installation</li>
</ul>
<p>Specifying <em>multiple operating systems</em> causes the execution of <em>multiple jobs</em> in the same build</p>
<p><em>Note</em>: Some languages or system configurations may be unavailable for some environments!</p>
<ul>
<li>e.g., there is no <code>java</code> environment available on <code>windows</code></li>
</ul>
</section><section>
<h2 id="custom-environment">Custom environment</h2>
<p>If a particular environment of need is unavailable, one solution is
<br>
<strong>build it yourself</strong></p>
<ul>
<li>start from <code>language: minimal</code></li>
<li>if the software you need is installable via <strong>apt</strong> or <strong>homebrew</strong>, use the <code>addons</code> keyword:</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="nohighlight" data-noescape><span style="color:#080;font-weight:bold">addons</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#080;font-weight:bold">apt</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">packages</span>:<span style="color:#bbb"> </span>foo<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#080;font-weight:bold">homebrew</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">packages</span>:<span style="color:#bbb"> </span>bar<span style="color:#bbb">
</span></code></pre></div><ul>
<li>install packages under windows using <strong><a href="https://chocolatey.org/">chocolatey</a></strong> (pre installed on Travis Windows instances)</li>
<li>if you need to perform a manual installation, you can write it in bash</li>
</ul>
</section><section>
<h2 id="improved-resilience-on-travis">Improved resilience on Travis</h2>
<ul>
<li>operations that may fail due to network issues or long time can be worked around using Travis built in functions:
<ul>
<li><code>travis_retry COMMAND</code> tries the same <code>COMMAND</code> three times, giving up only if it fails for three times</li>
<li><code>travis_wait N COMMAND</code> allows <code>COMMAND</code> to run without any output for longer than the default 10 minutes.
<ul>
<li>The hard limit on 50 minutes per job however remains</li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="a-java-custom-environment">A Java custom environment</h2>
<p>It could be useful to test on specific versions of the JDK, for instance.
<br>
A multi platform installer exists: <a href="https://github.com/shyiko/jabba">Jabba</a></p>
<p>Also, a Travis-CI dedicated tool has been written to ease installation via Travis: <a href="Gravis-CI">Gravis-CI</a></p>
<ul>
<li>Automatically installs Jabba</li>
<li>Uses Jabba to install the version of the JDK specified in the <code>JDK</code> environment variable</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="nohighlight" data-noescape><span style="color:#080;font-weight:bold">env</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#080;font-weight:bold">global</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- GRAVIS_REPO=<span style="color:#d20;background-color:#fff0f0">&#34;https://github.com/DanySK/Gravis-CI.git&#34;</span><span style="color:#bbb"> </span><span style="color:#888"># Convenience variable for shortening commands</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>- GRAVIS=<span style="color:#d20;background-color:#fff0f0">&#34;$HOME/gravis&#34;</span><span style="color:#bbb"> </span><span style="color:#888"># Convenience variable for shortening commands</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>- JDK=<span style="color:#d20;background-color:#fff0f0">&#34;adopt@1.11.0-8&#34;</span><span style="color:#bbb"> </span><span style="color:#888"># Partial versions supported, adopt@1.11 would pull the latest adopt 1.11</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#080;font-weight:bold">before_install</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- travis_retry<span style="color:#bbb"> </span>git<span style="color:#bbb"> </span>clone<span style="color:#bbb"> </span>--depth<span style="color:#bbb"> </span><span style="color:#00d;font-weight:bold">1</span><span style="color:#bbb"> </span>$GRAVIS_REPO<span style="color:#bbb"> </span>$GRAVIS<span style="color:#bbb"> </span><span style="color:#888"># Check out the script set</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span>- source<span style="color:#bbb"> </span>$GRAVIS/install-jdk<span style="color:#bbb"> </span><span style="color:#888"># Install the JDK you configured in the $JDK environment variable</span><span style="color:#bbb">
</span></code></pre></div></section><section>
<h2 id="build-matrix">Build Matrix</h2>
<p>Similarly to the operating systems, other environment features may need to get tested, e.g. the JDK versions</p>
<p>Travis automatically combines some variables into a <em><a href="https://docs.travis-ci.com/user/build-matrix/">build matrix</a></em></p>
<ul>
<li>Generates one job for each combination of such variable</li>
<li>Expands <code>os</code>, custom language keys (such as <code>rvm</code> or <code>python</code>), and <code>env.matrix</code> keys</li>
<li><code>jobs.include</code> can be used to add further jobs to the matrix</li>
<li><code>jobs.exclude</code> can be used to filter jobs out of the matrix</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="nohighlight" data-noescape>...<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#080;font-weight:bold">env</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#080;font-weight:bold">global</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>...<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#080;font-weight:bold">matrix</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- JDK=<span style="color:#d20;background-color:#fff0f0">&#34;adopt@&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>- JDK=<span style="color:#d20;background-color:#fff0f0">&#34;adopt@1.11&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>- JDK=<span style="color:#d20;background-color:#fff0f0">&#34;adopt-openj9@&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>- JDK=<span style="color:#d20;background-color:#fff0f0">&#34;adopt-openj9@1.11&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#080;font-weight:bold">jobs</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#080;font-weight:bold">include</span>:<span style="color:#bbb"> </span><span style="color:#888"># Add a job with default OS and the specified matrix environment</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">env</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>- JDK=<span style="color:#d20;background-color:#fff0f0">&#34;adopt@1.8&#34;</span><span style="color:#bbb"> 
</span><span style="color:#bbb">  </span><span style="color:#080;font-weight:bold">exclude</span>:<span style="color:#bbb"> </span><span style="color:#888"># Excludes builds with OSX and OpenJ9</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>- {<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">os: osx, env</span>:<span style="color:#bbb"> </span>[<span style="color:#bbb"> </span>JDK=<span style="color:#d20;background-color:#fff0f0">&#34;adopt-openj9@&#34;</span><span style="color:#bbb"> </span>]<span style="color:#bbb"> </span>}<span style="color:#bbb"> </span><span style="color:#888"># JSON-like syntax, YAML is a superset of JSON</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>- {<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">os: osx, env</span>:<span style="color:#bbb"> </span>[<span style="color:#bbb"> </span>JDK=<span style="color:#d20;background-color:#fff0f0">&#34;adopt-openj9@1.11&#34;</span><span style="color:#bbb"> </span>]<span style="color:#bbb"> </span>}<span style="color:#bbb">
</span></code></pre></div></section><section>
<h2 id="build-stages-and-workspaces">Build Stages and workspaces</h2>
<p>Spanning several jobs upfront may make the build very slow</p>
<ul>
<li>A single mistake will be detected only after all jobs failed</li>
<li>In case of limited resources, it can take a long time</li>
<li>Most errors will affect <em>all</em> builds</li>
</ul>
<p><strong>Build stages</strong> allow to group one or more jobs that are to be run in parallel</p>
<ul>
<li>By default, all jobs run the <code>test</code> stage</li>
<li>Jobs from a stage can communicate with jobs on another stage via <strong><a href="https://docs.travis-ci.com/user/using-workspaces/">workspaces</a></strong></li>
</ul>
<p>Consider for instance this structure:</p>
<ol>
<li>Run a build on the <em>reference</em> environment</li>
<li>If successul, then <em>test on all the supported configurations</em></li>
<li>If everything is successful, then <em>deploy</em></li>
</ol>
<p>this can be mapped into a <em>three-stages</em> configuration</p>
</section><section>
<h2 id="travis-yaml-validation">Travis YAML validation</h2>
<ul>
<li>
<p>Builds can get <em>complex</em></p>
</li>
<li>
<p>The corrisponding YAML file can get <em>rich</em></p>
</li>
<li>
<p>Syntax <em>errors are possible and likely</em></p>
</li>
<li>
<p>Use <em><a href="https://yaml.org/spec/1.2/spec.html#id2765878">anchors</a></em> and <em><a href="https://yaml.org/type/merge.html">merge keys</a></em> to foster reuse</p>
</li>
<li>
<p><em>Validate</em> YAML before pushing</p>
<ul>
<li>Travis CI provides a Ruby tool for this!</li>
</ul>
</li>
</ul>
<br>
<br>
<h4 id="using-travis-from-the-local-terminal">Using <code>travis</code> from the local terminal</h4>
<ul>
<li>Installation: <code>gem install travis</code>
<ul>
<li>Make sure you have the Gem install folder in your <code>PATH</code></li>
</ul>
</li>
<li>Run <code>travis lint</code> to verify if your YAML file complies</li>
</ul>
</section><section>
<h2 id="private-data-and-continuous-integration">Private data and continuous integration</h2>
<p>We would like the CI to be able to</p>
<ul>
<li>Sign our artifacts</li>
<li>Delivery/Deploy our artifacts on remote targets</li>
</ul>
<p>Both operations <strong>require private information to be shared</strong></p>
<p>Of course, private data <em>can&rsquo;t be shared</em></p>
<ul>
<li>Attackers may steal the identity</li>
<li>Attackers may compromise deployments</li>
<li>In case of open projects, attackers may exploit <em>pull requests</em>!
<ul>
<li>Fork your project (which has e.g. a secret environment variable)</li>
<li>Print the value of the secret (e.g. with <code>printenv</code>)</li>
</ul>
</li>
</ul>
<p>How to <em>share a secret</em> with the build environment?</p>
</section><section>
<h2 id="sharing-a-secret">Sharing a secret</h2>
<p>Travis supports the insertion of secret <strong>variables</strong> in two ways:</p>
<ul>
<li>From the <em>web interface</em> (easier, quicker)
<ul>
<li>More options $\Rightarrow$ Settings $\Rightarrow$ Environment variables</li>
</ul>
</li>
<li>From the <em>command line</em> (more compleicated)
<ul>
<li><code>travis encrypt &lt;String to encrypt&gt;  --pro</code>
<ul>
<li>e.g., <code>travis encrypt 'PASSWORD=&quot;foobar&quot;'</code></li>
</ul>
</li>
<li>produces a <code>secure: &lt;code&gt;</code> entry that can be pasted in <code>.travis.yml</code>
<ul>
<li>e.g.:</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="nohighlight" data-noescape><span style="color:#080;font-weight:bold">env</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#080;font-weight:bold">global</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">secure</span>:<span style="color:#bbb"> </span>&lt;code&gt;<span style="color:#bbb">
</span></code></pre></div><p>Travis also supports sharing a <strong>single secret file</strong></p>
<ul>
<li>It gets encrypted using <code>travis encrypt-file &lt;file&gt; --pro</code></li>
<li>The output command must be included in <code>.travis.yml</code>
<ul>
<li>e.g. in the <code>before_install</code> phase of any job requiring it</li>
</ul>
</li>
<li>The resulting encrypted file must be tracked
<ul>
<li>Be careful not to track the original one!</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="shared-secrets-best-practices">Shared secrets: best practices</h2>
<ul>
<li>Leverage the single shared file for sharing an <strong>ASCII-armored</strong> PGP key
<ul>
<li>Allows for <em>signing</em> artifacts</li>
<li><em>Signing keys are large</em> and cannot fit a variable</li>
<li>Obtain it with <code>gpg --armor --export-secret-keys &gt; secrets.asc</code></li>
<li>Encrypt with <code>travis encrypt-file secrets.asc --pro</code></li>
<li>Remove it (<code>rm secrets.asc</code>)</li>
<li>Track the encrypted file <code>git add secrets.asc.enc</code></li>
<li>In the <code>install</code> or <code>before_install</code> phase:
<ul>
<li>Add the <code>openssl</code> command printed by travis in the <code>before_install</code> phase</li>
<li>Add <code>export ORG_GRADLE_PROJECT_signingKey=$(cat secrets.asc)</code></li>
</ul>
</li>
</ul>
</li>
<li>In case you need <em>multiple files</em>:
<ul>
<li>create an archive, encrypt it, decrypt on the build server, and unpack there</li>
</ul>
</li>
<li>Store <em>passwords</em> into <em>encrypted variables</em></li>
<li>Secrets are <em>only available in builds launched from the original repository</em>
<ul>
<li>Otherwise there&rsquo;d be no protection from <em>pull request attacks</em></li>
<li><em>Make sure pull requests can build without secrets</em>!</li>
<li>e.g. by <em>excluding phases or jobs</em> that use secrets</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="signing-using-in-memory-keys-in-gradle">Signing using in-memory keys in Gradle</h2>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="nohighlight" data-noescape><span style="color:#080;font-weight:bold">if</span> (System.getenv(<span style="color:#d20;background-color:#fff0f0">&#34;CI&#34;</span>) == <span style="color:#080;font-weight:bold">true</span>.toString()) {
    signing {
        <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">signingKey</span>: String? <span style="color:#080;font-weight:bold">by</span> project
        <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">signingPassword</span>: String? <span style="color:#080;font-weight:bold">by</span> project
        useInMemoryPgpKeys(signingKey, signingPassword)
    }
}
</code></pre></div><ul>
<li>The <code>CI</code> environment variable is automatically set to true on Travis CI
<ul>
<li>See <a href="https://docs.travis-ci.com/user/environment-variables/#default-environment-variables">https://docs.travis-ci.com/user/environment-variables/#default-environment-variables</a></li>
</ul>
</li>
<li>The <code>signingKey</code> and <code>signingPassword</code> properties must get <em>passed</em> to Gradle
<ul>
<li>The best way is probably by exporting them as environment variables</li>
<li>Gradle auto-imports properties named <code>ORG_GRADLE_PROJECT_&lt;variableName&gt;</code></li>
<li>This mechanism can be exploited to inject properties using environment variables:
<ul>
<li><code>export ORG_GRADLE_PROJECT_signingKey=$(cat secrets.asc)</code></li>
<li>A secret variable named <code>ORG_GRADLE_PROJECT_signingPassword</code> from the web UI</li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="conditional-jobs-stages-and-deployments">Conditional jobs, stages, and deployments</h2>
<p>One way to prevent pull requests to run deployment phases that would fail
<br>
(due to unavailability of secrets)
<br>
is to use <strong>conditional jobs, stages, and deployments</strong></p>
<p>To do so, the keyword <code>if</code> can be used:</p>
<ul>
<li>On the whole build, to skip it entirely</li>
<li>On a <code>stages</code> entry, to skip a single stage</li>
<li>On a <code>jobs.include</code> entry, to exclude that job</li>
</ul>
<p>The <a href="https://docs.travis-ci.com/user/conditions-v1">Travis condition syntax is documented at https://docs.travis-ci.com/user/conditions-v1</a></p>
</section><section>
<h2 id="travis-cis-deploy">Travis CI&rsquo;s <code>deploy</code></h2>
<p>The <code>deploy</code> phase is special in Travis:</p>
<ul>
<li>It does not allow to run custom commands</li>
<li>It expects entries with:
<ul>
<li>A deploy provider</li>
<li>A configuration</li>
</ul>
</li>
</ul>
<p>Full reference: <a href="https://docs.travis-ci.com/user/deployment-v2">https://docs.travis-ci.com/user/deployment-v2</a></p>
<p>Example:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="nohighlight" data-noescape><span style="color:#080;font-weight:bold">deploy</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#080;font-weight:bold">provider</span>:<span style="color:#bbb"> </span>releases<span style="color:#bbb"> </span><span style="color:#888"># Deploys on GitHub Releases</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#080;font-weight:bold">file</span>:<span style="color:#bbb"> </span>build/libs/<span style="color:#c00;font-weight:bold">*.jar</span><span style="color:#bbb"> </span><span style="color:#888"># Files to deploy</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#080;font-weight:bold">edge</span>:<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">true</span><span style="color:#bbb"> </span><span style="color:#888"># opt in to the new deploy API</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#080;font-weight:bold">on</span>:<span style="color:#bbb"> </span><span style="color:#888"># filter</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">all_branches</span>:<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">true</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#888"># tags: true # deploy only tags</span><span style="color:#bbb">
</span></code></pre></div></section><section>
<h1 id="stale-builds">Stale builds</h1>
<ol>
<li>Stuff <em>works</em></li>
<li><em>Nobody touches it</em> for months</li>
<li>Untouched stuff is now <em>borked</em>!</li>
</ol>
<p>Ever happenend?</p>
<ul>
<li>Connected to the issue of build reproducibility</li>
<li>The default configuration of Travis CI may change
<ul>
<li>By the way, explicitly using <code>dist</code> for Linux builds may help</li>
</ul>
</li>
<li>Some tools may become unavailable</li>
<li>Some dependencies may get unavailable</li>
</ul>
<p><strong>The sooner the issue is known, the better</strong></p>
<p>$\Rightarrow$ <em>Automatically run the build every some time</em> even if nobody touches the project</p>
<ul>
<li>How often? Depends on the project&hellip;</li>
</ul>
</section><section>
<h2 id="additional-checks-and-reportings">Additional checks and reportings</h2>
<p>There exist a number of recommended services that provide additional QA and reports.</p>
<p>Non exhaustive list:</p>
<ul>
<li><a href="https://codecov.io/">Codecov.io</a>
<ul>
<li>Code coverage</li>
<li>Supports Jacoco XML reports</li>
<li>Nice data reporting system</li>
</ul>
</li>
<li><a href="https://sonarcloud.io/">Sonarcloud</a>
<ul>
<li>Multiple measures, covering reliability, security, maintainability, duplication, complexity&hellip;</li>
</ul>
</li>
<li><a href="https://www.codacy.com/">Codacy</a>
<ul>
<li>Automated software QA for several languages</li>
</ul>
</li>
<li><a href="https://www.codefactor.io/">Code Factor</a>
<ul>
<li>Automated software QA</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="high-quality-floss-checklist">High quality FLOSS checklist</h2>
<p>The <a href="https://www.linuxfoundation.org/">Linux Foundation</a> <a href="https://www.coreinfrastructure.org/">Core Infrastructure Initiative</a> created a checklist for high quality FLOSS.</p>
<p><strong><a href="https://bestpractices.coreinfrastructure.org/en">CII Best Practices Badge Program https://bestpractices.coreinfrastructure.org/en</a></strong></p>
<ul>
<li><em>Self-certification</em>: no need for bureaucracy</li>
<li>Provides a nice <em>TODO list</em> for a high quality product</li>
<li>Releases a <em>badge</em> that can be added e.g. to the project homepage</li>
</ul>
</section>

  


</div>
      

    </div>
<script type="text/javascript" src=/Course-Laboratory-of-Software-Systems/reveal-hugo/object-assign.js></script>

<a href="/Course-Laboratory-of-Software-Systems/reveal-js/css/print/" id="print-location" style="display: none;"></a>
<script type="text/javascript">
  var printLocationElement = document.getElementById('print-location');
  var link = document.createElement('link');
  link.rel = 'stylesheet';
  link.type = 'text/css';
  link.href = printLocationElement.href + (window.location.search.match(/print-pdf/gi) ? 'pdf.css' : 'paper.css');
  document.getElementsByTagName('head')[0].appendChild(link);
</script>

<script type="application/json" id="reveal-hugo-site-params">{"height":"100%","pdfseparatefragments":false,"theme":"white","width":"100%"}</script>
<script type="application/json" id="reveal-hugo-page-params">{"custom_theme":"custom-theme.scss","custom_theme_compile":true,"custom_theme_options":{"enablesourcemap":true,"targetpath":"css/custom-theme.css"},"transition":"slide","transition_speed":"fast"}</script>

<script src="/Course-Laboratory-of-Software-Systems/reveal-js/js/reveal.js"></script>

<script type="text/javascript">
  
  
  function camelize(map) {
    if (map) {
      Object.keys(map).forEach(function(k) {
        newK = k.replace(/(\_\w)/g, function(m) { return m[1].toUpperCase() });
        if (newK != k) {
          map[newK] = map[k];
          delete map[k];
        }
      });
    }
    return map;
  }
  
  var revealHugoDefaults = { center: true, controls: true, history: true, progress: true, transition: "slide" };
  var revealHugoSiteParams = JSON.parse(document.getElementById('reveal-hugo-site-params').innerHTML);
  var revealHugoPageParams = JSON.parse(document.getElementById('reveal-hugo-page-params').innerHTML);
  
  var options = Object.assign({},
    camelize(revealHugoDefaults),
    camelize(revealHugoSiteParams),
    camelize(revealHugoPageParams));
  Reveal.initialize(options);
</script>


  
  
  <script type="text/javascript" src="/Course-Laboratory-of-Software-Systems/reveal-js/plugin/markdown/marked.js"></script>
  
  <script type="text/javascript" src="/Course-Laboratory-of-Software-Systems/reveal-js/plugin/markdown/markdown.js"></script>
  
  <script type="text/javascript" src="/Course-Laboratory-of-Software-Systems/reveal-js/plugin/highlight/highlight.js"></script>
  
  <script type="text/javascript" src="/Course-Laboratory-of-Software-Systems/reveal-js/plugin/zoom-js/zoom.js"></script>
  
  
  <script type="text/javascript" src="/Course-Laboratory-of-Software-Systems/reveal-js/plugin/notes/notes.js"></script>



    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
</script>

<script type="text/javascript" id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>

    
  </body>
</html>
